<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BSEQ-sc: Deconvolution of Bulk Sequencing Experiments using Single Cell Data • bseqsc</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- Custom css --><link href="style.css" rel="stylesheet">
<!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">BSEQ-sc</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../vignettes/bseq-sc.html">Tutorial</a>
</li>
<li>
  <a href="../reference/index.html">Documentation</a>
</li>
<li>
  <a href="../articles/pages/data.html">Data</a>
</li>
<li>
  <a href="../articles/pages/installation.html">Installation</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/shenorrlab/bseq-sc">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>BSEQ-sc: Deconvolution of Bulk Sequencing Experiments using Single Cell Data</h1>
                  <div class="author">
            <h4 class="author">Renaud Gaujoux</h4>
            <address class="author_afil">
      Systems Immunology Lab, Technion, Haifa, Israel<br>
</address>                  </div>
            <div class="author">
            <h4 class="author">Maayan Baron</h4>
            <address class="author_afil">
      Institute for Computational Medicine, NYU School of Medicine, New York, USA<br>
</address>                  </div>
      
          </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      <p>This vignette provides a walk through tutorial on how to use Bseq-sc to estimate cell type proportions from bulk sequencing data based on prior single cell data, and integrate them into a cell type-specific differential analysis. It serves as a companion document to the analysis performed in the original publication (Baron et al. 2016 – Cell Systems).</p>
    </div>
    
<div class="contents">
<div id="how-to-cite-r-bseqsc" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#how-to-cite-r-bseqsc" class="anchor"> </a></body></html>How to cite <code class="unnumbered">r BSEQSC</code>
</h2>
<p>When using this work in any way, please cite the following work:</p>
<blockquote>
<p><em>A single-cell transcriptomic map of the human and mouse pancreas reveals inter- and intra-cell population structure</em><br><small>M. Baron, A. Veres, S.L. Wolock, A. L. Faust, R. Gaujoux, A. Vetere, J. Hyoje Ryu, B. K. Wagner, S. Shen-Orr, A. M. Klein, D. A. Melton, I. Yanai<br></small> Cell Systems. 2016 Oct 26 <a href="https://www.ncbi.nlm.nih.gov/pubmed/27667365">10.1016/j.cels.2016.08.011</a></p>
</blockquote>
</div>
<div id="requirements" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#requirements" class="anchor"> </a></body></html>Requirements</h1>
<div id="software" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#software" class="anchor"> </a></body></html>Software</h2>
<p>In order to run the entire deconvolution pipeline, users need to install the <em><a href="https://github.com/shenorrlab/bseq-sc">bseqsc</a></em> R package from GitHub. See the <a href="installation.html">installtion instructions</a> for details.</p>
</div>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#data" class="anchor"> </a></body></html>Data</h2>
<p>BSEQ-sc uses two types of input data:</p>
<ul>
<li>bulk data obtained from RNA sequencing of mixed tissue samples: these are the data we want to deconvolve;</li>
<li>data from single cell RNA sequencing: these serve to compute cell type-specific reference profiles that are used to estimate cell type proportions in the bulk data.</li>
</ul>
<hr>
</div>
</div>
<div id="bseq-sc-analysis-pipeline" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#bseq-sc-analysis-pipeline" class="anchor"> </a></body></html>BSEQ-sc analysis pipeline</h1>
<p>Single cell RNA-seq information is used to deconvolve bulk RNA-seq samples by estimating the cell-type proportion of key cell-types. Statistical deconvolution is then used to leverage the variation in cell type frequencies between individuals to estimate average cell-type specific expression in 2 groups of individuals and to compute cell type-specific differential expression.</p>
<p>We used this approach to investigate gene expression differences between diabetics and healthy individuals, using single cell RNA-seq data obtained from an independent set of pancreatic islets (Figure 1). However, it is applicable to other type of tissue, for which both bulk and single cell gene expression data are available.</p>
<div class="figure">
<img src="images/pipeline-800x600.png">
</div>
<hr>
</div>
<div id="sample-analysis" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#sample-analysis" class="anchor"> </a></body></html>Sample analysis</h1>
<p>We reproduce here the analysis detailed in <span class="citation">(Baron et al. 2016)</span>.</p>
<ul>
<li>Total gene expression data were obtained from GEO dataset <a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE50244">GSE50244</a>, which contains data on gobal transcriptomic analysis of bulk human pancreatic islets to study glucose metabolism in healthy and hyper-glycemic conditions <span class="citation">(Fadista et al. 2014)</span>.</li>
<li>Single cell RNA-seq data were generated by us from pancreatic islets from an independent set of 3 healthy indiviuals.</li>
</ul>
<div id="data-preparation" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#data-preparation" class="anchor"> </a></body></html>Data preparation</h2>
<p>Bioconductor base package provides the <code>ExpressionSet</code> class, which is a convenient data structure to hold expression data along with sample/feature annotation. Here we use two <code>ExpressionSet</code> objects to handle the bulk and single cell data respectively.</p>
<div id="bulk-data" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#bulk-data" class="anchor"> </a></body></html>Bulk data</h3>
<p>The dataset’s <a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE50244">GEO entry (GSE50244)</a> contains raw RNA-seq and sample annotation data. For the purpose of this vignette, we will use data that we pre-processed and made available on the <a href="http://shenorrlab.github.io/BSeq-sc/data">data download page</a>.</p>
<p>After pre-processing, the data were filtered to remove unmapped tags, or tags that mapped to pseudogenes, or known ribosomal/mithocondrial genes (list available in file <code>data/genes_mitrib.txt.gz</code> or via function <code><a href="../reference/getMITRIB.html">getMITRIB()</a></code> provided in the package). Moreover, counts from transcripts that mapped to a same gene were averaged. Sample phenotypic annotations were also processed to define glycemic groups based on <em>hba1c</em> measurements, as per the original publication <span class="citation">(Fadista et al. 2014)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># download GEO dataset from Github</span>
eset &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">'http://shenorrlab.github.io/BSeq-sc/data/GSE50244.rds'</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># for this analysis we only look at samples with hba1c data</span>
eset &lt;-<span class="st"> </span><span class="kw">droplevels</span>(eset[, !<span class="kw">is.na</span>(eset$hba1c)])
eset</code></pre></div>
<pre><code>## ExpressionSet (storageMode: lockedEnvironment)
## assayData: 17921 features, 70 samples 
##   element names: exprs 
## protocolData: none
## phenoData
##   sampleNames: GSM1216753 GSM1216755 ... GSM1216834 (70 total)
##   varLabels: geo_accession tissue ... ageN (11 total)
##   varMetadata: labelDescription
## featureData
##   featureNames: A1BG A1CF ... ZAK (17921 total)
##   fvarLabels: Gene0 ENTREZID Symbol Description
##   fvarMetadata: labelDescription
## experimentData: use 'experimentData(object)'
## Annotation:</code></pre>
</div>
<div id="single-cell-data" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#single-cell-data" class="anchor"> </a></body></html>Single cell data</h3>
<p>We generated single cell RNA-seq data of pancreatic islets from 3 healthy individuals, which provided gene expression profiles for 17434 genes in 7729 cells. The raw counts for these data are available on the <a href="http://shenorrlab.github.io/BSeq-sc/data">data download page</a>, in the form of an <code>ExpressionSet</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">eislet &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">'http://shenorrlab.github.io/BSeq-sc/data/islet-eset.rds'</span>)
eislet</code></pre></div>
<p>After identification of the cell types by clustering, we extract marker genes for each cell type, i.e. sets of genes that are mostly highly expressed in each cell type, which can be done in multiple ways, see for example details in <span class="citation">(Baron et al. 2016)</span>.</p>
<p>The bseqsc package provides the list of selected marker genes for the pancreatic islets, stored in data object <code>pancreasMarkers</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(pancreasMarkers)
<span class="kw">str</span>(pancreasMarkers)</code></pre></div>
<pre><code>## List of 6
##  $ alpha : chr [1:14] "GCG" "TTR" "IRX2" "SLC7A2" ...
##  $ beta  : chr [1:7] "INS" "IAPP" "IGF2" "DLK1" ...
##  $ delta : chr [1:5] "SST" "LEPR" "RBP4" "RGS2" ...
##  $ gamma : chr [1:6] "PPY" "STMN2" "ARX" "MEIS2" ...
##  $ ductal: chr [1:11] "KRT19" "TACSTD2" "ANXA2" "S100A10" ...
##  $ acinar: chr [1:19] "CTRB1" "CELA3A" "CELA3B" "CTRB2" ...</code></pre>
<hr>
</div>
</div>
<div id="estimation-of-cell-type-proportions" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#estimation-of-cell-type-proportions" class="anchor"> </a></body></html>Estimation of cell type proportions</h2>
<p>Once cell type-specific markers have been identified, we build a reference basis matrix from their single cell gene expression, which we use to infer the composition of bulk tissue samples from their total gene expression.</p>
<div id="building-the-reference-basis-matrix" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#building-the-reference-basis-matrix" class="anchor"> </a></body></html>Building the reference basis matrix</h3>
<p>The purpose of this matrix is to provide reference expression profiles that together discriminate the cell types of interest. We compute it by averaging, within each cell type, the gene expression of each marker gene across all the cells in the cell type.</p>
<p>Notably, the computation is performed on scaled single cell count data, to better reflect cell type-specific variations in average transcript counts. Indeed, looking at the average counts within each cell type shows how cell types have varying levels of RNA transcripts:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># average counts computed within each cell type in each sample</span>
<span class="kw"><a href="../reference/plotCellTotals.html">plotCellTotals</a></span>(eislet, <span class="st">'cellType'</span>, <span class="st">'sampleID'</span>)</code></pre></div>
<p><img src="bseq-sc_files/figure-html/cell_totals-1.png" width="800px"></p>
<p>Because we want the basis matrix of reference profiles to reflect these biological differences, we use these average counts to re-scale the CPM data before computing the average gene expression.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">B &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bseqsc_basis.html">bseqsc_basis</a></span>(eislet, pancreasMarkers, <span class="dt">clusters =</span> <span class="st">'cellType'</span>, <span class="dt">samples =</span> <span class="st">'sampleID'</span>, <span class="dt">ct.scale =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>The resulting basis matrix should show a clear cell type-specific expression pattern (Figure 2):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plotBasis.html">plotBasis</a></span>(B, pancreasMarkers, <span class="dt">Colv =</span> <span class="ot">NA</span>, <span class="dt">Rowv =</span> <span class="ot">NA</span>, <span class="dt">layout =</span> <span class="st">'_'</span>, <span class="dt">col =</span> <span class="st">'Blues'</span>)</code></pre></div>
<div class="figure">
<img src="bseq-sc_files/figure-html/basis_heatmap-1.png" alt="**Figure 2:** Basis matrix of gene expression reference profiles from pancreatic cell type derived from single cell RNA-seq data." width="800px"><p class="caption">
<strong>Figure 2:</strong> Basis matrix of gene expression reference profiles from pancreatic cell type derived from single cell RNA-seq data.
</p>
</div>
</div>
<div id="estimating-proportions" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#estimating-proportions" class="anchor"> </a></body></html>Estimating proportions</h3>
<p>Cell type proportions are estimated using CIBERSORT, a method that was developed to investigate immune infiltrating landscape in tumour tissue <span class="citation">(Newman et al. 2015; Gentles et al. 2015)</span> (See section Requirements for setup instructions).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bseqsc_proportions.html">bseqsc_proportions</a></span>(eset, B, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)
## * Data features: 'A1BG', 'A1CF', ..., 'ZAK' (17,921 total)
## * Basis features: 'GCG', 'TTR', ..., 'CPB1' (62 total)
## * Common features: 'ADCYAP1', 'ANXA2', ..., 'TTR' (60 total)
## * Writing input files ...
## OK
## * Running CIBERSORT ...
## OK</code></pre></div>
<p>To facilitate plotting and model fitting in downstream analysis, we add the estimated proportions as extra phenotypic variables to the <code>ExpressionSet</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pData</span>(eset) &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">pData</span>(eset), <span class="kw">t</span>(<span class="kw">coef</span>(fit)))</code></pre></div>
Estimated proportions can then be compared between the two HBA1C groups, within each cell type (Figure 3).
<div class="figure">
<img src="bseq-sc_files/figure-html/prop_plot-1.png" alt="**Figure 3:** Estimated cell type proportions in each Normoglycemic (blue) and hyperglycemic (red) individuals." width="800px"><p class="caption">
<strong>Figure 3:</strong> Estimated cell type proportions in each Normoglycemic (blue) and hyperglycemic (red) individuals.
</p>
</div>
<hr>
</div>
</div>
<div id="gene-expression-differences-adjusted-for-proportions" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#gene-expression-differences-adjusted-for-proportions" class="anchor"> </a></body></html>Gene expression differences adjusted for proportions</h2>
<p>Now that we have estimates for the main cell types, we can use <em><a href="http://bioconductor.org/packages/EdgeR">EdgeR</a></em> to derive a set of genes that are likely to be differentially regulated at the cell type level.</p>
<p>To do so, we fit 2 models of gene expression differences between HBA1C groups (IGT, Diabetic, Normal): * a base model only includes the HBA1C group variable, as well as gender and age covariates; * an extended model that additionally includes the proportions of alpha, beta, ductal and acinar cells.</p>
<p>Genes that are likely to be differentially regulated at the cell type level are those whose p-values improve (i.e. decrease) when adjusting for cell type proportions (red dots on Figure 4). Here we used a p-value threshold of 0.01.</p>
<p>To fit these models we use the utility function <code>fitEdgeR</code> included in the package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fitEdgeR</code></pre></div>
<pre><code>## function(x, formula, coef){
##   design &lt;- model.matrix(formula, data = pData(x))
##   esetA &lt;- x[, rownames(design)]
##   y &lt;- DGEList(counts = exprs(esetA), genes = fData(esetA))
##   y &lt;- calcNormFactors(y)
##   y &lt;- estimateDisp(y, design)
##   fit &lt;- glmQLFit(y, design)
##   qlf &lt;- glmQLFTest(fit, coef = coef)
##   top &lt;- topTags(qlf, n = Inf)
##   top$fit &lt;- fit
##   top
##   
## }
## &lt;environment: namespace:bseqsc&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># base</span>
fit_edger &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitEdgeR.html">fitEdgeR</a></span>(eset, ~<span class="st"> </span>gender +<span class="st"> </span>ageN +<span class="st"> </span>hba1c_class, <span class="dt">coef =</span> <span class="kw">c</span>(<span class="st">'hba1c_classIGT'</span>, <span class="st">'hba1c_classDiabetic'</span>))
<span class="co"># extended</span>
fit_edger_ext &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitEdgeR.html">fitEdgeR</a></span>(eset, ~<span class="st"> </span>gender +<span class="st"> </span>ageN +<span class="st"> </span>alpha +<span class="st"> </span>beta +<span class="st"> </span>ductal +<span class="st"> </span>acinar +<span class="st"> </span>hba1c_class
                          , <span class="dt">coef =</span> <span class="kw">c</span>(<span class="st">'hba1c_classIGT'</span>, <span class="st">'hba1c_classDiabetic'</span>))</code></pre></div>
<p>We then visualize</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># gather P-values from both models</span>
edger_pvals &lt;-<span class="st"> </span><span class="kw">cbind</span>(fit_edger$table[, <span class="st">'Symbol'</span>, <span class="dt">drop =</span> <span class="ot">FALSE</span>], <span class="dt">Base =</span> fit_edger$table$PValue
               , <span class="dt">Adjusted =</span> fit_edger_ext$table$PValue[<span class="kw">match</span>(fit_edger$table$Symbol, fit_edger_ext$table$Symbol)]
               , <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)

edger_pvals &lt;-<span class="st"> </span><span class="kw">mutate</span>(edger_pvals, <span class="dt">Regulated =</span> Adjusted &lt;=<span class="st"> </span><span class="fl">0.01</span> &amp;<span class="st"> </span>Adjusted &lt;=<span class="st"> </span>Base)

<span class="co"># plot Base vs Adjusted</span>
<span class="kw"><a href="../reference/pvalueScatter.html">pvalueScatter</a></span>(Base ~<span class="st"> </span>Adjusted, edger_pvals, <span class="dt">pval.th =</span> <span class="fl">0.01</span>, <span class="dt">label.th =</span> <span class="fl">3.5</span>)</code></pre></div>
<div class="figure">
<img src="bseq-sc_files/figure-html/edgeR_agg-1.png" alt="**Figure 4:** P-values comparison between the 2 EdgeR modesl: Base model (y-axis) and extended model (x-axis)." width="800px"><p class="caption">
<strong>Figure 4:</strong> P-values comparison between the 2 EdgeR modesl: Base model (y-axis) and extended model (x-axis).
</p>
</div>
<hr>
</div>
<div id="cell-type-specific-differential-expression" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#cell-type-specific-differential-expression" class="anchor"> </a></body></html>Cell type-specific differential expression</h2>
<p>Now, we run a cell type-specific differential analysis using <code>csSAM</code> <span class="citation">(S. S. Shen-Orr et al. 2010)</span>, on the subset of selected genes, to which we add a set of 6 ER stress-related genes, that were identified in the single cell data analysis (see details in <span class="citation">(Baron et al. 2016)</span>).</p>
<p><code>csSAM</code> fits a linear model that estimates interaction terms between cell proportions and a group variable. This imposes a constraint on the sample size within each group. For this reason we only inlude into the model the 4 cell types (alpha, beta, ductal and acinar cells), either due to their variation (Figure 3) or biological relevance.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ER genes</span>
genes_ER &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'HSPA5'</span>, <span class="st">'MAFA'</span>, <span class="st">'HERPUD1'</span>, <span class="st">'DDIT3'</span>, <span class="st">'UCN3'</span>, <span class="st">'NEUROD1'</span>)
<span class="co"># Fit on ER stress genes and genes regulated beyond cell type proportion differences</span>
genes &lt;-<span class="st"> </span><span class="kw">union</span>(genes_ER, <span class="kw">subset</span>(edger_pvals, Regulated)$Symbol)
<span class="co"># NB: we fix seed for reproducibility</span>
csfit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bseqsc_csdiff.html">bseqsc_csdiff</a></span>(eset[genes, ] ~<span class="st"> </span>gender +<span class="st"> </span>ageN +<span class="st"> </span>hba1c_class2 |<span class="st"> </span>alpha +<span class="st"> </span>beta +<span class="st"> </span>ductal +<span class="st"> </span>acinar,  <span class="dt">verbose =</span> <span class="dv">2</span>, <span class="dt">nperms =</span> <span class="dv">5000</span>, <span class="dt">.rng =</span> <span class="dv">12345</span>)</code></pre></div>
<pre><code>## Groups: Normal=47L | Hyper=23L | NA0L
## Cell type(s): 'alpha', 'beta', ..., 'acinar' (4 total)
## Fitting mode: auto
## Data (filtered): 254 features x 70 samples
## Model has extra covariates: fitting lm interaction model
## Fitting model with nonnegative effects
##  Fitting linear interaction model ...  OK
##  Computing FDR using 5000 permutations ... 5001/5000
##   Alternative 'two.sided' ...   OK
##   Alternative 'greater' ...   OK
##   Alternative 'less' ...   OK
##  OK
## Timing:
##    user  system elapsed 
##  42.508  78.460  33.536</code></pre>
<p>We observe a strong signal for up-regulation on beta cells (at FDR 0.05), and milder signals of up and down-regulation on acinar and beta cells respectively (at looser FDR 0.25).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">plot</span>(csfit, <span class="dt">alt =</span> <span class="kw">c</span>(<span class="st">'great'</span>, <span class="st">'less'</span>), <span class="dt">by =</span> <span class="st">'alt'</span>, <span class="dt">xlab =</span> <span class="st">'Number of significant genes'</span>, <span class="dt">ylab =</span> <span class="st">'FDR cutoff'</span>)
p$data$Cell.type &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">":Hyper"</span>, <span class="st">""</span>, p$data$Cell.type)
p$data$Alternative &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'greater'</span> =<span class="st"> 'Up-regulated'</span>, <span class="dt">less =</span> <span class="st">'Down-regulated'</span>)[<span class="kw">as.character</span>(p$data$Alternative)]
p +<span class="st"> </span><span class="kw">theme_get</span>()</code></pre></div>
<p><img src="bseq-sc_files/figure-html/fdrPlot-1.png" width="800px"></p>
<p>We filter these results for genes with the strongest signal in alpha, beta and acinar cells:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cst &lt;-<span class="st"> </span><span class="kw">csTopTable</span>(csfit, <span class="dt">threshold =</span> <span class="kw">c</span>(<span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">beta =</span> <span class="fl">0.25</span>, <span class="dt">acinar =</span> <span class="fl">0.25</span>), <span class="dt">alt =</span> <span class="st">'min'</span>, <span class="dt">merge =</span> <span class="ot">TRUE</span>, <span class="dt">n =</span> <span class="ot">Inf</span>, <span class="dt">nodups =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="../reference/plotEffectSize.html">plotEffectSize</a></span>(cst)</code></pre></div>
<p><img src="bseq-sc_files/figure-html/csfilter-1.png" width="800px"></p>
</div>
</div>
<div id="session-info" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#session-info" class="anchor"> </a></body></html>Session Info</h1>
<pre><code>## R version 3.3.3 (2017-03-06)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 16.04.2 LTS
## 
## locale:
##  [1] LC_CTYPE=en_ZA.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_ZA.UTF-8        LC_COLLATE=en_ZA.UTF-8    
##  [5] LC_MONETARY=en_ZA.UTF-8    LC_MESSAGES=en_ZA.UTF-8   
##  [7] LC_PAPER=en_ZA.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_ZA.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats     graphics  grDevices utils     datasets  methods  
## [8] base     
## 
## other attached packages:
##  [1] RColorBrewer_1.1-2    plyr_1.8.4            reshape2_1.4.2       
##  [4] ggplot2_2.2.1         BiocStyle_2.2.1       knitr_1.15.1         
##  [7] bseqsc_1.0            synchronicity_1.1.9.1 bigmemory_4.5.19     
## [10] bigmemory.sri_0.1.3   Biobase_2.34.0        BiocGenerics_0.20.0  
## [13] csSAM_1.4             Rcpp_0.12.9           pkgdown_0.1.0.9000   
## [16] devtools_1.12.0.9000 
## 
## loaded via a namespace (and not attached):
##  [1] doParallel_1.0.10     rprojroot_1.2         prabclus_2.2-6       
##  [4] highlight_0.4.7       tools_3.3.3           backports_1.0.5      
##  [7] R6_2.2.0              DBI_0.6               lazyeval_0.2.0       
## [10] colorspace_1.3-2      trimcluster_0.1-2     nnet_7.3-12          
## [13] withr_1.0.2           gridExtra_2.2.1       xbioc_0.1.8          
## [16] preprocessCore_1.36.0 xml2_1.1.1            desc_1.1.0           
## [19] pkgmaker_0.26.5       labeling_0.3          diptest_0.75-7       
## [22] scales_0.4.1          DEoptimR_1.0-8        mvtnorm_1.0-6        
## [25] robustbase_0.92-7     NMF_0.23.4            commonmark_1.2       
## [28] stringr_1.2.0         digest_0.6.12         rmarkdown_1.3.9004   
## [31] htmltools_0.3.5       highr_0.6             limma_3.30.12        
## [34] RSQLite_1.1-2         mclust_5.2.2          dendextend_1.4.0     
## [37] dplyr_0.5.0           magrittr_1.5          modeltools_0.2-21    
## [40] Formula_1.2-1         munsell_0.4.3         S4Vectors_0.12.1     
## [43] abind_1.4-5           viridis_0.3.4         stringi_1.1.2        
## [46] whisker_0.3-2         yaml_2.1.14           edgeR_3.16.5         
## [49] MASS_7.3-45           flexmix_2.3-13        pkgbuild_0.0.0.9000  
## [52] grid_3.3.3            crayon_1.3.2          lattice_0.20-34      
## [55] locfit_1.5-9.1        magick_0.3            tcltk_3.3.3          
## [58] fpc_2.1-10            rngtools_1.2.4        codetools_0.2-15     
## [61] stats4_3.3.3          pkgload_0.0.0.9000    evaluate_0.10        
## [64] foreach_1.4.3         testthat_1.0.2        gtable_0.2.0         
## [67] purrr_0.2.2           kernlab_0.9-25        assertthat_0.1       
## [70] gridBase_0.4-7        openxlsx_4.0.0        xtable_1.8-2         
## [73] e1071_1.6-8           roxygen2_6.0.1        class_7.3-14         
## [76] tibble_1.2            iterators_1.0.8       AnnotationDbi_1.36.2 
## [79] registry_0.3          memoise_1.0.0         IRanges_2.8.1        
## [82] cluster_2.0.5</code></pre>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<html><body><a href="#references" class="anchor"> </a></body></html>References</h1>
<div id="refs" class="references">
<div id="ref-Baron2016">
<p>Baron, Maayan, Adrian Veres, Samuel L. Wolock, Aubrey L. Faust, Renaud Gaujoux, Amedeo Vetere, Jennifer Hyoje Ryu, et al. 2016. “A Single-Cell Transcriptomic Map of the Human and Mouse Pancreas Reveals Inter- and Intra-cell Population Structure.” <em>Cell Systems</em> 3 (4). Elsevier Inc.: 346–60. doi:<a href="https://doi.org/10.1016/j.cels.2016.08.011">10.1016/j.cels.2016.08.011</a>.</p>
</div>
<div id="ref-Fadista2014">
<p>Fadista, João, Petter Vikman, Emilia Ottosson Laakso, Inês Guerra Mollet, Jonathan Lou Esguerra, Jalal Taneera, Petter Storm, et al. 2014. “Global genomic and transcriptomic analysis of human pancreatic islets reveals novel genes influencing glucose metabolism.” <em>Proceedings of the National Academy of Sciences</em> 111 (38): 13924–9. doi:<a href="https://doi.org/10.1073/pnas.1402665111">10.1073/pnas.1402665111</a>.</p>
</div>
<div id="ref-Gentles2015">
<p>Gentles, Andrew J, Aaron M Newman, Chih Long Liu, Scott V Bratman, Weiguo Feng, Dongkyoon Kim, Viswam S Nair, et al. 2015. “The prognostic landscape of genes and infiltrating immune cells across human cancers.” <em>Nature Medicine</em> 21 (8). Nature Publishing Group: 938–45. doi:<a href="https://doi.org/10.1038/nm.3909">10.1038/nm.3909</a>.</p>
</div>
<div id="ref-Newman2015">
<p>Newman, Aaron M, Chih Long Liu, Michael R Green, Andrew J Gentles, Weiguo Feng, Yue Xu, Chuong D Hoang, Maximilian Diehn, and Ash a Alizadeh. 2015. “Robust enumeration of cell subsets from tissue expression profiles.” <em>Nature Methods</em>, no. MAY 2014. Nature Publishing Group: 1–10. doi:<a href="https://doi.org/10.1038/nmeth.3337">10.1038/nmeth.3337</a>.</p>
</div>
<div id="ref-Shen-Orr2010">
<p>Shen-Orr, Shai S, Robert Tibshirani, Purvesh Khatri, Dale L Bodian, Frank Staedtler, Nicholas M Perry, Trevor Hastie, Minnie M Sarwal, Mark M Davis, and Atul J Butte. 2010. “Cell type-specific gene expression differences in complex tissues.” <em>Nature Methods</em> 7 (4). Nature Publishing Group: 287–9. doi:<a href="https://doi.org/10.1038/nmeth.1439">10.1038/nmeth.1439</a>.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#how-to-cite-r-bseqsc">How to cite <code class="unnumbered">r BSEQSC</code></a></li>
      <li>
<a href="#requirements">Requirements</a><ul class="nav nav-pills nav-stacked">
<li><a href="#software">Software</a></li>
      <li><a href="#data">Data</a></li>
      </ul>
</li>
      <li><a href="#bseq-sc-analysis-pipeline">BSEQ-sc analysis pipeline</a></li>
      <li>
<a href="#sample-analysis">Sample analysis</a><ul class="nav nav-pills nav-stacked">
<li><a href="#data-preparation">Data preparation</a></li>
      <li><a href="#estimation-of-cell-type-proportions">Estimation of cell type proportions</a></li>
      <li><a href="#gene-expression-differences-adjusted-for-proportions">Gene expression differences adjusted for proportions</a></li>
      <li><a href="#cell-type-specific-differential-expression">Cell type-specific differential expression</a></li>
      </ul>
</li>
      <li><a href="#session-info">Session Info</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Renaud Gaujoux, Maayan Baron.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
